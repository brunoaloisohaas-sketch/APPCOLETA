<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>LF Transportes ‚Äî App de Coleta</title>
  <meta name="theme-color" content="#ffa500" />
  <link rel="stylesheet" href="style.css">
</head>
<body>
  <header class="app-header">
    <div class="brand">
      <div class="logo" style="display:flex;align-items:center;justify-content:center;color:var(--lf-blue);font-weight:bold">LF</div>
      <h1>LF Transportes ‚Ä¢ App de Coleta</h1>
    </div>
    <span class="badge">v2.0 com Scanner</span>
  </header>

  <div class="container">
    <!-- Navega√ß√£o -->
    <nav class="tabs" aria-label="Navega√ß√£o de abas">
      <button class="tab-btn active" data-tab="dash">Dashboard</button>
      <button class="tab-btn" data-tab="check">Checklist</button>
      <button class="tab-btn" data-tab="nf">Cadastrar NF</button>
      <button class="tab-btn" data-tab="eta">ETA</button>
      <button class="tab-btn" data-tab="sum">Resumo</button>
    </nav>

    <!-- DASHBOARD -->
    <section id="dash" class="tab card" style="display:block;">
      <div class="card-title">
        <h2>üìä Dashboard</h2>
        <div class="row">
          <label>De: <input type="date" id="filtroInicio" /></label>
          <label>At√©: <input type="date" id="filtroFim" /></label>
          <button class="btn-primary" onclick="exportNFs()">Exportar CSV</button>
        </div>
      </div>
      <div id="dashCards" class="grid grid-3"></div>
    </section>

    <!-- CHECKLIST -->
    <section id="check" class="tab card" style="display:none;">
      <h2>‚úÖ Checklist</h2>
      <div id="checklist" class="list">
        <label class="check-item"><input type="checkbox" /> Pneus calibrados</label>
        <label class="check-item"><input type="checkbox" /> Luzes funcionando</label>
        <label class="check-item"><input type="checkbox" /> Lacres conferidos</label>
        <label class="check-item"><input type="checkbox" /> Documentos em m√£os</label>
      </div>
    </section>

    <!-- CADASTRAR NF -->
    <section id="nf" class="tab card" style="display:none;">
      <h2>üßæ Cadastrar Nota Fiscal</h2>
      
      <!-- Scanner Section -->
      <div class="row">
        <button class="btn-primary" id="btScannerNF" style="display: flex; align-items: center; gap: 8px;">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
            <path d="M4 7V5C4 4.44772 4.44772 4 5 4H7" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
            <path d="M4 17V19C4 19.5523 4.44772 20 5 20H7" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
            <path d="M20 17H22C22.5523 17 23 17.4477 23 18V20" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
            <path d="M20 7H22C22.5523 7 23 6.55228 23 6V4" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
            <rect x="1" y="1" width="22" height="22" rx="3" stroke="currentColor" stroke-width="2"/>
            <path d="M8 10H16V14H8V10Z" fill="currentColor"/>
          </svg>
          Escanear NF
        </button>
      </div>
      
      <div id="scanner-container">
        <div class="scanner-overlay">
          <div class="scanner-frame"></div>
        </div>
        <video id="scanner-video"></video>
        <div class="scanner-controls">
          <button class="btn-ghost" id="btStopScanner">Parar Scanner</button>
        </div>
      </div>
      
      <div class="grid grid-2" style="margin-top:10px">
        <div class="card">
          <h3>Dados b√°sicos</h3>
          <label>N√∫mero NF <input id="nfNumero" /></label>
          <label>Data/Hora coleta <input id="nfDataHora" type="datetime-local" /></label>
          <label>Remetente <input id="nfRem" /></label>
          <label>Destinat√°rio <input id="nfDest" /></label>
          <div class="grid grid-2">
            <label>Volumes <input id="nfVolumes" type="number" min="0" /></label>
            <label>Peso (kg) <input id="nfPeso" type="number" step="0.01" min="0" /></label>
          </div>
          <div class="grid grid-2">
            <label>m¬≥ <input id="nfM3" type="number" step="0.01" min="0" /></label>
            <label>Rota
              <select id="nfRota">
                <option>Fortaleza</option>
                <option>Bel√©m</option>
                <option>Manaus</option>
                <option>Boa Vista</option>
                <option>Outra</option>
              </select>
            </label>
          </div>
          <label>Respons√°vel <input id="nfResp" /></label>
          <label>Observa√ß√µes <textarea id="nfObs" rows="3"></textarea></label>
          <button class="btn-primary" id="btSalvarNF">Salvar NF</button>
        </div>
      </div>
    </section>

    <!-- ETA -->
    <section id="eta" class="tab card" style="display:none;">
      <h2>‚è±Ô∏è ETA</h2>
      <div class="grid grid-3 compact-grid">
        <label>Partida <input id="etaPartida" type="datetime-local" /></label>
        <label>Dura√ß√£o (min) <input id="etaMin" type="number" min="1" /></label>
        <div class="row">
          <button class="btn-primary" id="btCalcETA">Calcular</button>
          <button class="btn-ghost" id="btSalvarETA">Salvar ETA</button>
        </div>
      </div>
      <p id="etaOut" class="eta-out">‚Äî</p>
    </section>

    <!-- RESUMO -->
    <section id="sum" class="tab card" style="display:none;">
      <h2>üßæ Resumo</h2>
      <div id="sumResumo"></div>
    </section>

    <!-- Controles de Admin -->
    <section class="card">
      <h3>üîê Administra√ß√£o</h3>
      <div class="row">
        <button class="btn-primary" onclick="loginAdmin()">Entrar como Admin</button>
        <button class="btn-ghost" onclick="logoutAdmin()">Sair do Admin</button>
      </div>
    </section>
  </div>
<script>
// ===== ESTADO E FUN√á√ïES PRINCIPAIS =====
const LS = { nfs:'xg_nfs', admin:'xg_admin' };
let nfs = [];
let scannerActive = false;
let videoStream = null;
let scanningInterval = null;

// ===== CONFIGURA√á√ÉO DO GOOGLE SHEETS =====
const SHEET_ID = '1ig1MZazD9bzCbZyxV34PXz0PZDMS9P8JOhO_E-dULwg';
const SHEET_NAME = 'coleta';
const API_URL = 'https://script.google.com/macros/s/AKfycbzE1_t6Yuqpu8wOlH3Ht-eU7pG7CviuiaKnW64HzIopTg2OZhaWYiFHrS6GExFjV5yUHg/exec';

// Fun√ß√µes utilit√°rias
function loadLS(key, fallback){ 
  try{ 
    return JSON.parse(localStorage.getItem(key)) ?? fallback; 
  } catch(e){ 
    return fallback; 
  } 
}

function saveLS(key, val){ 
  localStorage.setItem(key, JSON.stringify(val)); 
}

function isMobile() {
  return /Mobi|Android/i.test(navigator.userAgent);
}

function isAdmin() {
  return localStorage.getItem(LS.admin) === "true";
}

function loginAdmin() {
  localStorage.setItem(LS.admin, "true");
  alert("Modo administrador ativado");
  renderDashboardCards();
}

function logoutAdmin() {
  localStorage.removeItem(LS.admin);
  alert("Saiu do modo administrador");
  renderDashboardCards();
}

// ===== FUN√á√ïES PARA GOOGLE SHEETS =====
async function saveToSheets(nfData) {
  if (!navigator.onLine) {
    // Salvar localmente se offline e sincronizar depois
    const pendingSync = loadLS('pendingSync', []);
    pendingSync.push(nfData);
    saveLS('pendingSync', pendingSync);
    return { success: true, offline: true };
  }

  try {
    const response = await fetch(API_URL, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
      },
      body: JSON.stringify({
        action: 'addNF',
        sheetId: SHEET_ID,
        sheetName: SHEET_NAME,
        data: nfData
      })
    });
    
    const result = await response.json();
    return result;
  } catch (error) {
    console.error('Erro ao salvar no Google Sheets:', error);
    // Fallback para localStorage em caso de erro
    const pendingSync = loadLS('pendingSync', []);
    pendingSync.push(nfData);
    saveLS('pendingSync', pendingSync);
    return { success: false, error: error.message };
  }
}

async function loadFromSheets() {
  if (!navigator.onLine) {
    // Usar dados locais se offline
    return loadLS(LS.nfs, []);
  }

  try {
    const response = await fetch(`${API_URL}?action=getNFs&sheetId=${SHEET_ID}&sheetName=${SHEET_NAME}`);
    const data = await response.json();
    
    if (data.success && data.data) {
      // Salvar localmente para uso offline
      saveLS(LS.nfs, data.data);
      return data.data;
    } else {
      throw new Error(data.error || 'Erro ao carregar dados');
    }
  } catch (error) {
    console.error('Erro ao carregar do Google Sheets:', error);
    // Fallback para localStorage em caso de erro
    return loadLS(LS.nfs, []);
  }
}

async function syncPendingData() {
  if (!navigator.onLine) return;
  
  const pendingSync = loadLS('pendingSync', []);
  if (pendingSync.length === 0) return;
  
  for (let i = 0; i < pendingSync.length; i++) {
    const result = await saveToSheets(pendingSync[i]);
    if (result.success && !result.offline) {
      // Remover item sincronizado com sucesso
      pendingSync.splice(i, 1);
      i--;
    }
  }
  
  saveLS('pendingSync', pendingSync);
}

// ===== DASHBOARD =====
function renderDashboardCards() {
  const container = document.getElementById("dashCards");
  if (!container) return;

  container.innerHTML = "";

  // Modo simplificado no celular (n√£o-admin)
  if (isMobile() && !isAdmin()) {
    container.innerHTML = "<p class='muted'>üì± Vers√£o simplificada no celular (somente Admin v√™ os cards completos).</p>";
    return;
  }

  // Aplicar filtros de data
  const startInp = document.getElementById("filtroInicio");
  const endInp = document.getElementById("filtroFim");
  const start = startInp && startInp.value ? new Date(startInp.value + 'T00:00:00') : null;
  const end = endInp && endInp.value ? new Date(endInp.value + 'T23:59:59') : null;

  let nfsFiltradas = nfs;
  if (start || end) {
    nfsFiltradas = nfs.filter(nf => {
      if (!nf.datahora) return false;
      const nfDate = new Date(nf.datahora);
      const afterStart = start ? nfDate >= start : true;
      const beforeEnd = end ? nfDate <= end : true;
      return afterStart && beforeEnd;
    });
  }

  if (!nfsFiltradas || !nfsFiltradas.length) {
    container.innerHTML = "<div class='empty'>Nenhuma NF encontrada para o per√≠odo selecionado.</div>";
    return;
  }

  // Agrupar por rota
  const agrupado = {};
  nfsFiltradas.forEach(nf => {
    const rota = nf.rota || 'Outra';
    if (!agrupado[rota]) {
      agrupado[rota] = {
        qtd: 0,
        volumes: 0,
        peso: 0,
        m3: 0,
        nfs: []
      };
    }
    
    agrupado[rota].qtd += 1;
    agrupado[rota].volumes += Number(nf.volumes || 0);
    agrupado[rota].peso += Number(nf.peso || 0);
    agrupado[rota].m3 += Number(nf.m3 || 0);
    agrupado[rota].nfs.push(nf);
  });

  // Criar cards
  for (const rota in agrupado) {
    const dados = agrupado[rota];
    const card = document.createElement("div");
    card.className = "card";
    card.innerHTML = `
      <h3>${rota}</h3>
      <div class="kpi"><span class="big">${dados.qtd}</span> NFs</div>
      <div class="kpi"><span class="big">${dados.volumes}</span> Volumes</div>
      <div class="kpi"><span class="big">${dados.peso.toFixed(2)}</span> kg</div>
      <div class="kpi"><span class="big">${dados.m3.toFixed(2)}</span> m¬≥</div>
    `;
    container.appendChild(card);
  }
}

// ===== EXPORTA√á√ÉO =====
function exportNFs() {
  const startInp = document.getElementById("filtroInicio");
  const endInp = document.getElementById("filtroFim");
  const start = startInp && startInp.value ? new Date(startInp.value) : null;
  const end = endInp && endInp.value ? new Date(endInp.value) : null;

  const filtradas = nfs.filter(nf => {
    if (!nf.datahora) return false;
    const d = new Date(nf.datahora);
    const afterStart = start ? d >= start : true;
    const beforeEnd = end ? d <= end : true;
    return afterStart && beforeEnd;
  });

  let csv = "NF,Data,Remetente,Destinat√°rio,Volumes,Peso,m¬≥,Rota\n";
  filtradas.forEach(nf => {
    csv += `${nf.numero},${nf.datahora},${nf.rem},${nf.dest},${nf.volumes},${nf.peso},${nf.m3},${nf.rota}\n`;
  });

  const blob = new Blob([csv], { type: "text/csv;charset=utf-8;" });
  const link = document.createElement("a");
  link.href = URL.createObjectURL(blob);
  link.download = "notas_filtradas.csv";
  document.body.appendChild(link);
  link.click();
  document.body.removeChild(link);
}

// ===== SCANNER =====
function hasCamera() {
  return !!(navigator.mediaDevices && navigator.mediaDevices.getUserMedia);
}

async function startScanner() {
  if (!hasCamera()) {
    alert('C√¢mera n√£o dispon√≠vel neste dispositivo');
    return;
  }
  
  try {
    // Solicitar acesso √† c√¢mera
    videoStream = await navigator.mediaDevices.getUserMedia({
      video: { 
        facingMode: 'environment', // Preferir c√¢mera traseira
        width: { ideal: 1280 },
        height: { ideal: 720 }
      }
    });
    
    // Exibir o v√≠deo
    const videoElement = document.getElementById('scanner-video');
    const scannerContainer = document.getElementById('scanner-container');
    
    videoElement.srcObject = videoStream;
    videoElement.setAttribute('playsinline', true); // Importante para iOS
    scannerContainer.classList.add('active');
    scannerActive = true;
    
    // Esperar o v√≠deo estar pronto
    videoElement.onloadedmetadata = function() {
      videoElement.play();
      
      // Iniciar processo de escaneamento
      scanningInterval = setInterval(scanBarcode, 300); // Reduzi a frequ√™ncia para melhor performance
    };
    
  } catch (error) {
    console.error('Erro ao acessar a c√¢mera:', error);
    alert('N√£o foi poss√≠vel acessar a c√¢mera: ' + error.message);
  }
}

function stopScanner() {
  scannerActive = false;
  const scannerContainer = document.getElementById('scanner-container');
  scannerContainer.classList.remove('active');
  
  if (scanningInterval) {
    clearInterval(scanningInterval);
    scanningInterval = null;
  }
  
  if (videoStream) {
    videoStream.getTracks().forEach(track => track.stop());
    videoStream = null;
  }
  
  const videoElement = document.getElementById('scanner-video');
  if (videoElement) {
    videoElement.srcObject = null;
  }
}

function scanBarcode() {
  if (!scannerActive) return;
  
  const videoElement = document.getElementById('scanner-video');
  if (!videoElement || videoElement.readyState !== videoElement.HAVE_ENOUGH_DATA) {
    return;
  }
  
  // Criar canvas para processar a imagem
  const canvas = document.createElement('canvas');
  const context = canvas.getContext('2d');
  canvas.width = videoElement.videoWidth;
  canvas.height = videoElement.videoHeight;
  
  // Desenhar o frame atual do v√≠deo no canvas
  context.drawImage(videoElement, 0, 0, canvas.width, canvas.height);
  
  // Obter dados da imagem
  const imageData = context.getImageData(0, 0, canvas.width, canvas.height);
  
  // Tentar decodificar o c√≥digo
  const code = jsQR(imageData.data, imageData.width, imageData.height, {
    inversionAttempts: 'dontInvert',
  });
  
  // Se encontrou um c√≥digo v√°lido
  if (code) {
    // Extrair n√∫mero da NF (assumindo que o c√≥digo contenha apenas n√∫meros)
    const nfNumber = code.data.replace(/\D/g, '');
    
    if (nfNumber) {
      // Preencher o campo de n√∫mero da NF
      document.getElementById('nfNumero').value = nfNumber;
      
      // Focar no pr√≥ximo campo
      document.getElementById('nfDataHora')?.focus();
      
      // Parar o scanner
      stopScanner();
      
      // Feedback para o usu√°rio
      alert('NF escaneada: ' + nfNumber);
    }
  }
}

// ===== NF FUNCTIONS =====
async function salvarNF() {
  const nf = {
    numero: document.getElementById("nfNumero").value.trim(),
    datahora: document.getElementById("nfDataHora").value,
    rem: document.getElementById("nfRem").value.trim(),
    dest: document.getElementById("nfDest").value.trim(),
    volumes: Number(document.getElementById("nfVolumes").value||0),
    peso: Number(document.getElementById("nfPeso").value||0),
    m3: Number(document.getElementById("nfM3").value||0),
    rota: document.getElementById("nfRota").value,
    resp: document.getElementById("nfResp").value.trim(),
    obs: document.getElementById("nfObs").value.trim(),
    timestamp: new Date().toISOString() // Adicionar timestamp para controle
  };
  
  if(!nf.numero){ 
    alert("Informe n√∫mero da NF"); 
    return; 
  }
  
  // Adicionar √† lista local
  nfs.unshift(nf);
  saveLS(LS.nfs, nfs);
  
  // Tentar salvar no Google Sheets
  const result = await saveToSheets(nf);
  
  if (result.success) {
    alert(result.offline ? "NF salva localmente (sem conex√£o)" : "NF salva no sistema!");
  } else {
    alert("Erro ao salvar NF: " + (result.error || "Desconhecido"));
  }
  
  renderDashboardCards();
  atualizarResumo();
  
  // Limpar campos
  ["nfNumero","nfDataHora","nfRem","nfDest","nfVolumes","nfPeso","nfM3","nfResp","nfObs"].forEach(id=>{
    const el = document.getElementById(id); 
    if (el) el.value = "";
  });
}

function atualizarResumo() {
  const resumoEl = document.getElementById('sumResumo');
  if (!resumoEl) return;
  
  if (!nfs.length) {
    resumoEl.innerHTML = '<div class="empty">Nenhuma NF cadastrada</div>';
    return;
  }
  
  // Agrupar por rota
  const agrupado = {};
  nfs.forEach(nf => {
    const rota = nf.rota || 'Outra';
    if (!agrupado[rota]) {
      agrupado[rota] = {
        qtd: 0,
        volumes: 0,
        peso: 0,
        m3: 0
      };
    }
    
    agrupado[rota].qtd += 1;
    agrupado[rota].volumes += Number(nf.volumes || 0);
    agrupado[rota].peso += Number(nf.peso || 0);
    agrupado[rota].m3 += Number(nf.m3 || 0);
  });
  
  // Criar tabela
  let html = '<table class="table-resumo"><thead><tr><th>Rota</th><th>NFs</th><th>Volumes</th><th>Peso (kg)</th><th>m¬≥</th></tr></thead><tbody>';
  
  for (const rota in agrupado) {
    const dados = agrupado[rota];
    html += `<tr>
      <td>${rota}</td>
      <td>${dados.qtd}</td>
      <td>${dados.volumes}</td>
      <td>${dados.peso.toFixed(2)}</td>
      <td>${dados.m3.toFixed(2)}</td>
    </tr>`;
  }
  
  html += '</tbody></table>';
  resumoEl.innerHTML = html;
}

// ===== ETA FUNCTIONS =====
function calcularETA() {
  const partida = document.getElementById("etaPartida").value;
  const min = Number(document.getElementById("etaMin").value);
  if(!partida || !min){ 
    alert("Informe partida e dura√ß√£o"); 
    return; 
  }
  
  const d = new Date(partida);
  const eta = new Date(d.getTime() + min*60000);
  document.getElementById("etaOut").textContent = `Chegada prevista: ${eta.toLocaleString()}`;
}

function salvarETA() {
  localStorage.setItem("xg_eta", document.getElementById("etaOut").textContent);
  alert("ETA salvo no resumo!");
}

// ===== INITIALIZATION =====
document.addEventListener("DOMContentLoaded", async function() {
  // Carregar dados (primeiro do localStorage, depois tentar sincronizar com Sheets)
  nfs = loadLS(LS.nfs, []);
  
  // Configurar tabs
  document.querySelectorAll('.tab-btn').forEach(btn => {
    btn.addEventListener('click', ()=>{
      document.querySelectorAll('.tab-btn').forEach(b=>b.classList.remove('active'));
      btn.classList.add('active');
      document.querySelectorAll('.tab').forEach(sec=>{
        sec.style.display = (sec.id===btn.dataset.tab?'block':'none');
      });
    });
  });
  
  // Configurar scanner
  document.getElementById('btScannerNF').addEventListener('click', startScanner);
  document.getElementById('btStopScanner').addEventListener('click', stopScanner);
  
  // Configurar bot√£o salvar NF
  document.getElementById('btSalvarNF').addEventListener('click', salvarNF);
  
  // Configurar ETA
  document.getElementById('btCalcETA').addEventListener('click', calcularETA);
  document.getElementById('btSalvarETA').addEventListener('click', salvarETA);
  
  // Configurar filtros de data
  const filtroInicio = document.getElementById("filtroInicio");
  const filtroFim = document.getElementById("filtroFim");
  
  if (filtroInicio) {
    filtroInicio.addEventListener('change', renderDashboardCards);
  }
  
  if (filtroFim) {
    filtroFim.addEventListener('change', renderDashboardCards);
  }
  
  // Inicializar views
  renderDashboardCards();
  atualizarResumo();
  
  // Tentar carregar dados do Google Sheets em segundo plano
  if (navigator.onLine) {
    try {
      const sheetsData = await loadFromSheets();
      if (sheetsData.length > 0) {
        nfs = sheetsData;
        saveLS(LS.nfs, nfs);
        renderDashboardCards();
        atualizarResumo();
      }
      
      // Sincronizar dados pendentes
      await syncPendingData();
    } catch (error) {
      console.error('Erro ao sincronizar com Google Sheets:', error);
    }
  }
  
  // Service Worker
  if ("serviceWorker" in navigator) {
    navigator.serviceWorker.register("service-worker.js")
      .then(() => console.log("‚úÖ Service Worker registrado"))
      .catch(err => console.error("SW falhou:", err));
  }
});
</script>

  <!-- Scripts -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jsQR/1.4.0/jsQR.min.js"></script>
<script src="script.js"></script>

</body>
</html>
